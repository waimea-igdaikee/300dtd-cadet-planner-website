{#=====================================================
  Home page
  - Lists of allocations for this and next week passed in
  - Regular (non-admin) users can allocate / deallocate themselves from roles
  - Admins can allocate / deallocate any user from roles
  - Admins have a button to generate a set of empty allocations for this / next week if none exist
=====================================================#}

{% extends 'pages/base.jinja' %}


{% block title %}

    Parade Planner - Allocations

{% endblock %}


{% block content %}

    {# Create articles with allocation tables - one for this week, one for next week #}
    {% for allocations, week in [(allocations_this_week, 0), (allocations_next_week, 1)] %}
        <article>

            <h2>Parade Roles {{ "Next" if week else "This"}} Week</h2> {# Set the title appropriately #}
            {# If this week has allocations for it, show them. Otherwise, show a message, or if the user is an admin, a button to generate some #}
            {% if allocations %} 
                <table>

                    <thead>
                        <tr>
                            <th scope="col">Role (click for info)</th>
                            <th scope="col">Allocated to</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for allocation in allocations %}
                            <tr>
                                <td><a href="/roles?role={{ allocation.role_id }}#role_{{allocation.role_id}}">{{ allocation.role_name }}</a></td>

                                <td>
                                    {% if allocation.user_id %} {# If this role is allocated to someone #}

                                        {% if allocation.user_id == session.user_id %} {# If this role is allocated to the current user, bold their name #}
                                            <b>{{ allocation.user_name }}</b>
                                        {% else %}
                                            {{ allocation.user_name }}
                                        {% endif %}

                                        {% if allocation.user_id == session.user_id or session.admin %} {# If the user has permission, show the de-allocate button#}
                                            <b><a href="/allocate?remove=1&date={{ allocation.date }}&role={{ allocation.role_id }}">X</a></b>
                                        {% endif %}

                                    {% else %} {# If this role is not allocated to anyone #}

                                        {% if session.admin %} {# If user is admin, show a dropdown menu to allocate someone#}

                                            <details class="dropdown allocation">
                                                <summary>
                                                    Click to allocate someone
                                                </summary>
                                                <ul>
                                                    {% for user in users %}
                                                        <li><a href="/allocate_admin?remove=0&date={{ allocation.date }}&role={{ allocation.role_id }}&user_id={{ user.id }}">{{ user.name }}</a></li>
                                                    {% endfor %}
                                                </ul>
                                            </details>

                                        {% else %} {# For standard users, show a button to allocate themselves #}
                                            <a href="/allocate?remove=0&date={{ allocation.date }}&role={{ allocation.role_id }}">Click to accept</a></td>
                                        {% endif %}

                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>

                </table>
            {% elif session.admin %} {# If no roles exist for a given week, show a button to add them or a message depending on whether the user has admin #}
                <a href="/allocations_create?week={{week}}" role="button">Add parade roles for {{ "next" if week else "this"}} week</a>
            {% else %}
                <p>No parade roles have been put up for {{ "next" if week else "this"}} week.</p> {# Set the appropriate message depending on week #}
            {% endif %}

        </article>
    {% endfor %}
{% endblock %}